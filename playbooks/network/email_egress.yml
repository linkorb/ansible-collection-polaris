- name: Network - persistent email egress pinning
  hosts: '{{ target_group | default("polaris_hosts") }}'
  become: true
  tags:
    - polaris.network
    - polaris.network.email_egress
    - polaris.network.mail_egress
  vars:
    polaris_email_egress_defaults:
      enabled: false
      routing_table_id: 200
      routing_table_name: mailout
      rule_priority: 100
      source_rule_priority: 90
      fwmark: "0x25"
      docker_bridge_interface: docker_gwbridge
      smtp_ports: [25, 465, 587]
      rp_filter_mode: "2"

  tasks:
    - name: Merge default and host email egress settings
      ansible.builtin.set_fact:
        polaris_email_egress_effective: >-
          {{
            polaris_email_egress_defaults
            | combine(
              (
                polaris_email_egress
                if (polaris_email_egress is defined)
                else (polaris_mail_egress | default({}))
              ),
              recursive=True
            )
          }}

    - name: Skip host when email egress pinning is disabled
      ansible.builtin.meta: end_host
      when: not polaris_email_egress_effective.enabled | bool

    - name: Validate required email egress settings
      ansible.builtin.assert:
        that:
          - polaris_email_egress_effective.public_ip is defined
          - polaris_email_egress_effective.public_interface is defined
          - polaris_email_egress_effective.smtp_ports | length > 0

    - name: Detect public gateway from interface default route when not provided
      ansible.builtin.shell: >-
        ip -4 route show default dev {{ polaris_email_egress_effective.public_interface }}
        | awk '{for(i=1;i<=NF;i++) if($i=="via"){print $(i+1); exit}}'
      register: polaris_email_egress_public_route
      changed_when: false
      when: polaris_email_egress_effective.public_gateway is not defined

    - name: Finalize public gateway setting
      ansible.builtin.set_fact:
        polaris_email_egress_effective: >-
          {{
            polaris_email_egress_effective
            | combine({
              'public_gateway': (
                polaris_email_egress_effective.public_gateway
                if polaris_email_egress_effective.public_gateway is defined
                else (polaris_email_egress_public_route.stdout | trim)
              )
            }, recursive=True)
          }}

    - name: Validate resolved public gateway
      ansible.builtin.assert:
        that:
          - polaris_email_egress_effective.public_gateway is defined
          - polaris_email_egress_effective.public_gateway | length > 0

    - name: Build interface list for rp_filter configuration
      ansible.builtin.set_fact:
        polaris_email_egress_rp_filter_interfaces: >-
          {{
            (
              [
                'all',
                'default',
                polaris_email_egress_effective.public_interface,
                polaris_email_egress_effective.docker_bridge_interface
              ]
              + (
                [polaris_email_egress_effective.private_interface]
                if (polaris_email_egress_effective.private_interface | default('') | length > 0)
                else []
              )
            ) | unique
          }}

    - name: Set rp_filter to loose mode for asymmetric routing support
      ansible.posix.sysctl:
        name: "net.ipv4.conf.{{ item }}.rp_filter"
        value: "{{ polaris_email_egress_effective.rp_filter_mode }}"
        state: present
        sysctl_set: true
        reload: false
      loop: "{{ polaris_email_egress_rp_filter_interfaces }}"

    - name: Ensure dedicated routing table name exists
      ansible.builtin.lineinfile:
        path: /etc/iproute2/rt_tables
        regexp: "^{{ polaris_email_egress_effective.routing_table_id }}\\s+"
        line: "{{ polaris_email_egress_effective.routing_table_id }} {{ polaris_email_egress_effective.routing_table_name }}"
        state: present

    - name: Disable legacy mail egress service if present
      ansible.builtin.systemd:
        name: polaris-mail-egress.service
        enabled: false
        state: stopped
      failed_when: false

    - name: Remove legacy mail egress service unit
      ansible.builtin.file:
        path: /etc/systemd/system/polaris-mail-egress.service
        state: absent

    - name: Remove legacy mail egress script
      ansible.builtin.file:
        path: /usr/local/sbin/polaris-mail-egress.sh
        state: absent

    - name: Install email egress apply script
      ansible.builtin.template:
        src: templates/polaris-email-egress.sh.j2
        dest: /usr/local/sbin/polaris-email-egress.sh
        owner: root
        group: root
        mode: "0755"
      notify: restart polaris-email-egress

    - name: Install email egress systemd unit
      ansible.builtin.template:
        src: templates/polaris-email-egress.service.j2
        dest: /etc/systemd/system/polaris-email-egress.service
        owner: root
        group: root
        mode: "0644"
      notify: restart polaris-email-egress

    - name: Ensure email egress service is enabled
      ansible.builtin.systemd:
        name: polaris-email-egress.service
        enabled: true
        daemon_reload: true

    - name: Apply email egress rules now
      ansible.builtin.command: /usr/local/sbin/polaris-email-egress.sh
      changed_when: false

  handlers:
    - name: restart polaris-email-egress
      ansible.builtin.systemd:
        name: polaris-email-egress.service
        enabled: true
        state: restarted
        daemon_reload: true
